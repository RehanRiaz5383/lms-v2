name: Auto Deploy LMS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Pull Latest Changes
        run: |
          cd /var/www/lms
          # Use -f to force overwrite if there are local untracked changes
          export GIT_SSH_COMMAND="ssh -i /home/deployer/.ssh/deployer -o StrictHostKeyChecking=no"
          git fetch --all
          git reset --hard origin/main

      - name: Upgrade Backend Database
        run: |
          # Hits your custom endpoint to trigger migrations/seeders
          curl -s -X GET https://lms-v2.techinnsolutions.net/upgrade-db
          echo "Database upgrade triggered."

      - name: Build Frontend
        run: |
          cd /var/www/lms/frontend
          # Use --no-audit to save memory if your server is small
          npm install --no-audit
          npm run build
      - name: Setup Chatbot
        run: |
          cd /var/www/lms/chatbot
          npm install --no-audit
          # Check if PM2 process exists, restart if it does, start if it doesn't
          if pm2 list | grep -q "lms-chatbot"; then
            echo "Restarting existing lms-chatbot process..."
            pm2 restart lms-chatbot
          else
            echo "Starting new lms-chatbot process..."
            pm2 start server.js --name lms-chatbot
            pm2 save
          fi
          # Show status
          pm2 status lms-chatbot
